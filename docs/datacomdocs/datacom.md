info-center source DS channel console trap state off

# 现代数据通信的核心标准架构TCP/IP模型

- 应用层

  常见协议:HTTP、FTP、DNS、SMTP、SMB、SSH

- 传输层

  常见协议:TCP、UDP

- 网络层

  常见协议:IP、ICMP、ARP、IGMP、OSPF、BGP

- 数据链路层

  常见协议:Ethernet、IEEE 802.11(WIFI)、PPP、VLAN、STP



# 常见的数据通信设备

## 数据链路层

基于MAC地址的通信

- 二层交换机
- 无线AP
- 网络扩展卡(NIC)

## 网络层

基于IP地址的通信

- 路由器
- 无线AC控制器
- 胖AP(Fat AP)
- 三层交换机

## 网络安全设备

- 防火墙



# IPv4

IPv4地址由32位二进制数组成

```bash
二进制 11000000.10101000.00000001.00000001
十进制 192.168.1.1
```

## IPv4地址的组成部分

IPv4地址由网络号(Network ID)和主机号(Host ID)组成，通过子网掩码(Subnet Mask)划分

| 类型 | 范围                        | 用途             |
| ---- | --------------------------- | ---------------- |
| A类  | 1.0.0.0 - 126.255.255.255   | 超大型网络       |
| B类  | 128.0.0.0 - 192.255.255.255 | 中型网络         |
| C类  | 192.0.0.0 - 233.255.255.255 | 小型局域网       |
| D类  | 224.0.0.0 - 239.255.255.255 | 组播             |
| E类  | 240.0.0.0 - 255.255.255.255 | 保留用于科学研究 |

## 特殊的IPv4地址

私有地址(仅用于局域网内部使用，不直接在公网上路由)

| 范围                          | 子网掩码    |
| ----------------------------- | ----------- |
| 10.0.0.0 - 10.255.255.255     | 255.0.0.0   |
| 172.16.0.0 - 172.31.255.255   | 255.240.0.0 |
| 192.168.0.0 - 192.168.255.255 | 255.255.0.0 |

环回地址(loopback): 127.0.0.1 - 127.255.255.255 255.0.0.0(用于本机Loopback网卡的地址)

APIPA地址:169.254.0.0 - 169.254.255.255(PC无法通过DHCP获取IP时自动生成的临时地址)



## 子网划分

子网划分是将一个大的网络段切分成更小的逻辑子网，以减少广播风暴，节约IP地址

核心原理:通过子网掩码(Subnet Mask)的主机号(Host ID)借位给网络号(Network ID)



例如将IP:192.168.1.0 - 192.168.1.255,子网掩码:255.255.255.0这个网络段划分为两个逻辑子网

```bash
IP十进制:11000000.10101000.00000001.00000000 - 11000000.10101000.11111111.11111111
IP二进制:192.168.1.0 - 192.168.1.255
子网掩码十进制:255.255.255.0
子网掩码二进制:11111111.11111111.11111111.00000000
子网掩码二进制缩写CIDR(无类别域间路由):24

将其划分为两个逻辑则需要将子网掩码的主机号(Host ID)向前移一位
子网掩码十进制:255.255.255.128
子网掩码二进制:11111111.11111111.11111111.10000000
子网掩码二进制缩写CIDR(无类别域间路由):25

划分后的逻辑子网范围
--------
子网1
IP十进制:192.168.1.0 - 192.168.1.127
IP二进制:11000000.10101000.00000001.00000000 - 11000000.10101000.00000001.01111111
--------
--------
子网2
IP十进制:192.168.1.128 - 192.168.1.255
IP二进制:11000000.10101000.00000001.10000000 - 11000000.10101000.00000001.11111111

```

![子网划分测试1](./子网划分测试1.png)

![子网划分测试2](./子网划分测试2.png)

去除掉每个逻辑子网网段的网络地址和广播地址后子网1和子网2的可用地址为126个

子网1的可用地址范围为:192.168.1.1 - 192.168.1.126 网络地址:192.168.1.0 广播地址:192.168.1.127

子网2的可用地址范围为:192.168.1.129 - 192.168.1.254 网络地址:192.168.1.128 广播地址:192.168.1.255

PS:每个网段的网络位(Network ID)全为0的地址为网络地址(用于给路由器等设备标识该网段)，主机位(Host ID)全为1的地址为广播地址(当一个数据包的目的 IP 设置为广播地址时，该网段内的所有设备都会接收并处理这个包)，所以这两种地址都不可用于分配。



# VLAN(虚拟局域网)

## VLAN的核心功能

在二层网络中，交换机的通信是依靠广播转发数据给广播域中的所有设备，这会造成大量的流量占用带宽，而VLAN技术可以将广播限制在特定的逻辑组内，防止无效流量占用带宽，提升网络性能。而不同的VLAN之间的设备在二层是无法互访的，这使得网络的安全性得到了增强。

## VLAN的划分方式

- 基于设备端口的划分

​	直接指定交换机特定的端口属于哪个VLAN ID，但是设备更改了端口则需要重新配置，配置简单，最为普遍

- 基于MAC地址的划分

  指定设备的MAC地址属于哪个VLAN，如果设备更改了端口也不需要重新配置，但是录入MAC地址的工作量巨大

- 基于协议的划分

​	根据报文所属的协议类型(如IPv4,IPv6等)划分

- 基于子网的划分

  根据数据包的源IP地址网段划分



## VLAN的核心端口模式

- Access:

  主要用于连接终端设备，只允许一个唯一的VLAN，

  发送数据:会打上该端口所属的PVID(VLAN ID) Tag，如果接收到了携带Tag的数据帧，绝大多数交换机会直接丢弃

  接收数据:检查VLAN ID是否和端口的PVID一致，如果一致则会剥离数据帧的VLAN ID Tag再进行发送，如果不一致则直接丢弃数据帧。

- Trunk:

  主要用于交换机和交换机或路由器之间的连接，允许多个VLAN ID的流量通过

  发送数据:

  ①如果该数据帧的VLAN ID在端口允许通过的列表中则发送，否则不予发送

  ②如果该数据帧的VLAN ID和端口的PVID相同则剥离Tag发送，否则保持原始标签发送

  接收数据:

  ①如果是不带Tag的数据帧，则会打上本端口的PVID,然后检查该PVID是否在允许列表中，符合则接收

  ②如果是带Tag的数据帧，则检查该数据帧的VLAN ID是否在端口的允许通过列表中，允许则接收并进行后续转发，禁止则丢弃该数据帧

- Hybrid:

  主要用于复杂场景(隔离或共享网络)，结合了Access和Trunk的优点，可自行决定哪些VLAN数据帧该发，哪些该剥离标签

  发送数据:

  ①查询Untagged列表，如果数据帧的VLAN ID在这个列表里，交换机会剥离掉Tag再发送

  ②查询Tagged列表，如果数据帧的VLAN ID在这个列表里，则保留Tag原样发送

  ③如果这两个表里都没有则直接丢弃数据帧

  接收数据:

  ①收到不带Tag的数据帧，则打上本端口的PVID Tag并检查该PVID是否在端口的允许通过列表中，在列表中则接收，不在则丢弃

  ②收到带Tag的数据帧，直接检查该数据帧的VLAN ID是否在允许通过列表中，在列表中则接收，不在则丢弃



# 生成树

## 生成树的核心功能

在有冗余链路的场景中，阻塞冗余链路消除网络中可能存在的环路，且如果活动的路径发生故障时激活冗余链路，恢复网络的连通性

## STP的基本概念

### 根桥(Root Bridge)

对于一个STP网络，根桥在全网只有一个，它是整个网络的逻辑中心(但不一定是物理中心)，根桥会根据网络拓扑的变化而动态变化。当主链路发生故障激活冗余链路时，根桥会按照一定的时间间隔产生并向外发送配置BPDU，其他设备仅对该报文进行处理，传达拓扑变化记录，从而保证拓扑的稳定。

### BID(Bridge ID)

BID由16位的Bridge优先级和BridgeMAC地址组成，BID桥优先级占据高16位(其中高4位为优先级低12位为VLAN ID)，其余的低48位是MAC地址

### PID(Port ID)

PID由高4位的端口优先级和低12位的端口号组成

### 路径开销(RPC)

交换机用来衡量一条链路好坏的度量衡，带宽速度越大，开销值越小

| 链路速率 | **IEEE 802.1t (常用标准)** | **华为私有标准 (Legacy)** | **思科 Long 模式 (32位)** | **思科 Short 模式 (16位)** |
| :------- | :------------------------- | :------------------------ | :------------------------ | :------------------------- |
| 10 Mbps  | 2,000,000                  | 2,000                     | 2,000,000                 | 100                        |
| 100 Mbps | 200,000                    | 200                       | 200,000                   | 19                         |
| 1 Gbps   | 20,000                     | 20                        | 20,000                    | 4                          |
| 10 Gbps  | 2,000                      | 2                         | 2,000                     | 2                          |
| 100 Gbps | 200                        | 1                         | 200                       | 1                          |



## 选举机制

选举分为三个关键步骤，必须按顺序进行

### 一.选举根桥(Root Bridge)

根桥是整个网络的逻辑中心，所有路径计算都以此为起点

规则:

1. 先比较BID中的优先级，优先级数值最小则胜出
2. 若优先级都相同，则比较BID中的MAC地址，最小的MAC地址则胜出

### 二.选举根端口(Root Port)

非`根桥设备`需要选举出一个距离`根桥最近的端口`，负责将数据发往根桥

规则:

1. 按照到达根桥`累计的RPC(根路径开销)之和`最小的那个端口胜出
2. 若RPC相同，则比较对端交换机的BID，最小的BID则胜出
3. 若BID也相同，则比较对端发送端口的PID，最小的PID胜出
4. 若上述均相同，则比较本地接收端口的PID，最小的胜出

### 三.选举指定端口(Designated Port,DP)

每个网段必须有一个端口负责转发根桥发来的BPDU和数据流

规则:

1. 哪个端口所在的交换机距离根桥的RPC最小，该端口就是DP
2. 若RPC相同，比较该网段连接的两台交换机的BID，BID最小者的端口为DP
3. 若BID也相同，比较该网段自身的PID，PID最小端口为DP

- 根桥上所有的端口默认为指定端口

在完成上述选举后，则整个树形拓扑建立完毕。在拓扑稳定后，只有根端口和指定端口转发流量，既不是根端口，也不是指定端口的`落选端口`将被逻辑阻塞，被逻辑阻塞的端口不会转发用户数据，只接受BPDU，直到拓扑发生变化时才可能重新启用



STP端口状态

| 端口状态   | 目的                                                      | 说明                                         |
| ---------- | --------------------------------------------------------- | -------------------------------------------- |
| Forwarding | 端口既转发用户流量也处理BPDU报文。                        | 只有根端口或指定端口才能进入Forwarding状态。 |
| Learning   | 设备会根据收到的用户流量构建MAC地址表，但不转发用户流量。 | 过渡状态，增加Learning状态防止临时环路。     |
| Listening  | 确定端口角色，将选举出根桥、根端口和指定端口。            | 过渡状态。                                   |
| Blocking   | 端口仅仅接收并处理BPDU，不转发用户流量。                  | 阻塞端口的最终状态。                         |
| Disabled   | 端口不仅不处理BPDU报文，也不转发用户流量。                | 端口状态为Down。                             |



MSTP端口状态

| 端口状态   | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| Forwarding | 在这种状态下，端口既转发用户流量又处理BPDU报文。             |
| Learning   | 这是一种过渡状态。在Learning下，交换设备会根据收到的用户流量，构建MAC地址表，但不转发用户流量，所以叫做学习状态。Learning状态的端口处理BPDU报文。 |
| Discarding | Discarding状态的端口只接收BPDU报文。                         |



# 路由
